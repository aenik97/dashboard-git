library("shiny")
library("sqldf")
library("dplyr")
library("ggplot2")
library("Hmisc")
library("DT")
library("woeBinning")
library("InformationValue")
library("car")
library("reshape2")
library("scales")
# define ----

#DECIMAL_PLACES - ?????? ???????????????? ?? ???????????????? ?????????? DECIMAL_PLACES ???????????? ?????????? ?????????????? ??
DECIMAL_PLACES <- 4
#RATING_VECTOR - ???????????? ???????????? ?????????? 
  # ???????????? ???????????????????????? ??????????
  # ???????????? ????????????-??????????, ???????????????? ???????????????? ?????????????? - ?????????????? ?????????????? ???????????? (?? ??????????????????/??????????) ???? ???????????????????????????????? ???? PD ????????????????????
  # ???? ???????????? ???????????????? ???????????????? TRAIN ?? ?????????????? TEST
RATING_VECTOR <- c("MA1" = 0.01, "MA2" = 0.05, "MA3" = 0.07, "MB1" = 0.12, "MB2" = 0.15, "MB3" = 0.18, "MC1" = 0.22, 
                   "MC2" = 0.24, "MC3" = 0.26, "MD1" = 0.30, "MD2" = 0.31, "MD3" = 0.39, "ME1" = 0.42, "ME2" = 0.44, 
                   "ME3" = 0.49, "MF1" = 0.57 , "MF2" = 0.66, "MF3" = 0.70, "MG1" = 0.74, "MG2" = 0.80, "MG3" = 0.90, 
                   "MG4" = 1.0)
#CENTRAL_TREND - ?????????????????????? ??????????????????
  # ???????????? ???????????????????????? ??????????
  # ?????????? ?????? ?????????????????????????? ???????????? ?? Calibration level accuracy test (binomial)
  # (CENTRAL_TREND <- mean(df$PD) ?????????? ????????)
df <- read.csv("validation.csv")
CENTRAL_TREND <- mean(df$default_flg)

#GROUP_FACTOR_UNIQUE_SUFFIX - ???????????????????? ???????????? ?????? ???????? ?????????????????? ????????????????????
  # ???????????? ???????????????????????? ??????????
  # ?? ?????????????? ???????? ???????????????????? ?????????? ???????????????????? ??????????????????
GROUP_FACTOR_UNIQUE_SUFFIX <- "_woe"

#???????????? ???????????????????? ?? ???????????? ?????????????????????????? ????????????????????
  # ???????????? ???????????????????????? ??????????
TRAFFIC_LIGHTS <- c("GINI_FACTORS_RED" = 0.1, "GINI_FACTORS_GREEN" = 0.15, "GINI_RELATIVE_FACTORS_GREEN" = 0.05, "GINI_RELATIVE_FACTORS_RED" = 0.1, "iv_red" = 0.1, "iv_yellow" = 0.3, "p_value_red" = 0.05, "p_value_yellow" = 0.1, 
                    "binomial_calibration_accuracy_test_confedence_level_yellow" = 0.95, 
                    "binomial_calibration_accuracy_test_confedence_level_red" = 0.99,
                    "calibration_curve_accuracy_test_confedence_level_yellow" = 0.95, 
                    "calibration_curve_accuracy_test_confedence_level_red" = 0.99, 
                    "representativeness_red" = 0.25, "representativeness_yellow" = 0.1, 
                    "psi_red" = 0.25, "psi_yellow" = 0.1, 
                    "correlation_gold" = 0.999, "correlation_red" = 0.5, 
                    "vif_red" = 5.0, "vif_yellow" = 2.0, 
                    "herfendal_index_red" = 0.3, "herfendal_index_yellow" = 0.2,
                    "TURQUOISE" = 0, "AQUAMARINE" = 0.00001, "GREEN" = 0.02001, "YELLOW" = 0.05001, 
                    "ORANGE" = 0.10001, "SALMON" = 0.15001, "RED" = 0.20001, "FIREBRICK" = 0.25001)

## ???????????????????? ???????????? ?????????? ?? ?????????? ????????????
#df - ?????????????? ??????????????????
#df <- read.csv("validation.csv")

#?? ?????????????? X ?????? ?????????? ???????????? ?????????????? ??????????????
df$X <- NULL
# ???????????????? ?? ???????????? ?????? ???????????????? ???????? ?????????????? #temporary solution
df$REPORT_DT <- as.Date(df$REPORT_DT, origin = "1970-01-01")

# extract_meta - ?????????????????? ????????????????, ?????????????????? ???????????????????? ?????????????????? abt_meta() ?? ??????????????????
extract_meta <- function(df) {
  #???????????? ?????????????????? abt_meta
  abt_meta <<- as.data.frame(colnames(df))
  colnames(abt_meta) <<- "Variable"
  abt_meta$Variable <<- as.character(abt_meta$Variable)
  #?????????????????? ????????????????????(??????????????) ???????????????????? ???? ???????? ???????????? ???????????????????????? ?? ??????
  # Input - ?????????????? ???????????????????? ????????????
  # Target - ?????????????????????? ????????????????????
  # Period - ???????????????????? ???????????????????? ???? ???????????? ?????????????? ??????????????????/???????????????????? ?? ???????? ????????????
  # Score - ?????????????????? ???????????? ????????????
  # id - ???????????????????? ?????????????????? ??????????????
  abt_meta$Role <<- "Input"
  abt_meta$Role[abt_meta$Variable == "default_flg"] <<- "Target"
  abt_meta$Role[abt_meta$Variable == "REPORT_DT" | abt_meta$Variable == "period_label"] <<- "Period"
  abt_meta$Role[abt_meta$Variable == "PD"] <<- "Score"
  abt_meta$Role[abt_meta$Variable == "id"] <<- "Id"
  #?????????????????? ????????????????????(??????????????) ???????????????????? ???? ???????? ???????????? ???????????????????????? ?? ??????
  # interval - ????????????????
  # logical - ??????????????
  # factor - ?????????????????? ?? ??????????????????
  abt_meta$Type <<- sapply(df, class)
  abt_meta$Type <<- ifelse(abt_meta$Type == "integer" | abt_meta$Type == "numeric", "interval", abt_meta$Type)
  abt_meta$Type <<- ifelse(abt_meta$Type == "logical", "interval", abt_meta$Type)
  abt_meta$Type <<- ifelse(abt_meta$Type == "factor", "character", abt_meta$Type)
}
extract_meta(df)

#group_factors - ???????????????????? ???????????????????? ???????????????????? ??????????????????
group_factors <- colnames(select(df, ends_with(GROUP_FACTOR_UNIQUE_SUFFIX)))
#none_gr_factors - ?????????????? ???????????????????? ???? ???????????????????? ????????????????????
none_gr_factors <- abt_meta[abt_meta$Role == "Input" & abt_meta$Type == "interval", ]$Variable
none_gr_factors <- setdiff(none_gr_factors, group_factors)

#report_dates - ???????????????????????????? ???????????? ???????? ???????????? ??????
report_dates <- sort(unique(as.character(df$REPORT_DT)))
#make_period - ?????????????????? ?? df ?????????????? "period" ?????? 1-?????? ????????????????????(TRAIN), 2,3,4... - ?????????????????? ???? ?????????????????????? ???????????? ???????? 
make_period <- function() {
  tmp <- 1:length(report_dates)
  names(tmp) <- report_dates
  period <- 1 + tmp[as.character(df$REPORT_DT)]
  period[df$period == "TRAIN"] <- 1
  df <<- cbind(df, period)
}

#make_rating - ???????????????? ?????????????????? df, ???????????????????? ?????????????????? df ?? ?????????????????????????? ???????????? ?????????????????? "rating" ?? ???????????????????????? ?? ????????????-???????????? RATING_VECTOR
make_rating <- function(df) {
  df <- df[order(df$PD), ]
  rating <- c()
  df_test <- df[df$period_label == "TEST", ]
  df_train <- df[df$period_label == "TRAIN", ]
  d_vector <- c(1, RATING_VECTOR * nrow(df_test))
  for (i in 1 : (length(d_vector) - 1) )
    for (j in d_vector[i] : d_vector[i + 1])
      rating[j] <- names(RATING_VECTOR)[i]
  df_test <- cbind(df_test, rating)
  
  d_vector <- c(1, RATING_VECTOR * nrow(df_train))
  for (i in 1 : (length(d_vector) - 1) )
    for (j in d_vector[i] : d_vector[i + 1])
      rating[j] <- names(RATING_VECTOR)[i]
  df_train <- cbind(df_train, rating)
  
  return (rbind(df_train, df_test))
}
df <- make_rating(df)
make_period()

# Define UI ----
#???????????? - ?????? ???????????? ?????????? ???????????? ???????????? ?????????????? - ???????? ?????????????????? ???????????? ?????? ??????????????
ui <- fluidPage(
  titlePanel("Dashboard"),
  #???????????????? ?????????????????????????? ???????????????? ???????????????????? ???? ?????????????????? ?????????????? TEST/TRAIN
  tabsetPanel(
    type = "tabs",
    tabPanel(
      "Plot",
      selectInput(
        "select_factor",
        "Select Factor",
        choices = abt_meta[abt_meta$Role == 'Input', ]$Variable
      ),
      plotOutput("plt")
    ),
    #?????? ???????????? ???????????? ???????? ?????????????????? ?????????? ????????????????????, ???????????????????? ???????????????? ?? ?????????????? ??????????????
    tabPanel(
      "Info",
      dataTableOutput("tbl_df_dr")
    ),
    tabPanel(
      "Numeric factors",
      selectInput(
        "select_period_numeric",
        "Select Period",
        choices = as.vector(unique(df$period_label))
      ),
      dataTableOutput("tbl_df_numerics")
    ),
    tabPanel(
      "Character factors",
      selectInput(
        "select_period_character",
        "Select Period",
        choices = as.vector(unique(df$period_label))
      ),
      dataTableOutput("tbl_df_factors")
    ),
    tabPanel(
      "Default rate and concentration",
      fluidRow(
        column(
          6,
          selectInput(
            "select_factor_gr_dr",
            "Select Factor",
            choices = group_factors
          )
        ),
        column(
          6,
          dateRangeInput(
            "dates",
            "Date range",
            start = min(df$REPORT_DT), 
            end = max(df$REPORT_DT),
            min = min(df$REPORT_DT),
            max = max(df$REPORT_DT)
          )
        )
      ),
      plotOutput("plot_con_dr")
    ),
    tabPanel(
      "GINI",
      fluidRow(
        column(
          8,
          DT::dataTableOutput("Gini_per_factor_tbl")
        ),
        column(
          4,
          selectInput(
            "select_report_dt",
            "REPORT_DT",
            choices = as.vector(sort(unique(as.character(df$REPORT_DT))))
          )
        )
      ),
      fluidRow(
        column(
          8,
          plotOutput("Gini_report_plt")
        ),
        column(
          4,
          selectInput(
            "select_factor_gini",
            "Select Factor",
            choices = group_factors
          )
        )
      )
    ),
    tabPanel(
      "KS",
      fluidRow(
        column(
          8,
          plotOutput("ks_plot")
        ),
        column(
          4,
          selectInput(
            "select_period_ks",
            "select period",
            choices = as.vector(unique(df$period_label))
          )
        )
      )
    ),
    tabPanel(
      "VIF and herfendal index",
      checkboxInput("factors_VIF","select for group factors", value = TRUE),
      selectInput(
        "select_report_dt_VIF", 
        "Report date", 
        choices = report_dates
      ),
      dataTableOutput("tbl_inflation_factor_for_factors"), 
      dataTableOutput("tbl_herfendal_index")
    ),
    tabPanel(
      "Correlation analysis of factors",
      fluidRow(
          column(1,
                 checkboxGroupInput("Correlation_gr_variables", "Correlation gr variables", group_factors, selected = group_factors)
          ),
          column(11,
                 dataTableOutput("tbl_correlation_analysis_of_gr_factors")
                 )
          ),
      fluidRow(
             column(1,
                    checkboxGroupInput("Correlation_none_gr_variables", "Correlation none gr variables", none_gr_factors, selected = none_gr_factors)
             ),
             column(11, 
                    dataTableOutput("tbl_correlation_analysis_of_none_gr_factors")
             )
        )
      ),
    tabPanel(
      "Representativeness", 
      dataTableOutput("tbl_representativeness")
    ),
    tabPanel(
      "PSI",
      selectInput(
        "select_report_dt_PSI", 
        "Report date", 
        choices = report_dates
      ),
      dataTableOutput("tbl_psi"),
      plotOutput("plot_score_distribution")
    ), 
    tabPanel(
      "Calibration curve accuracy test", 
      checkboxInput("bayes_curve", "Bayes adjustment", value = FALSE), 
      dataTableOutput("tbl_curve"), 
      plotOutput("plot_curve_test")
    ), 
    tabPanel(
      "Chi-squared and Hosmer-Lemeshev statistics", 
      checkboxInput("bayes_adjustment_xi2", "Bayes adjustment", value = FALSE), 
      dataTableOutput("tbl_Xi2"), 
      dataTableOutput("tbl_HL_statistic")
    ), 
    tabPanel(
      "IV", 
      selectInput(
        "select_report_dt_iv", 
        "Report date", 
        choices = report_dates
      ), 
      dataTableOutput("tbl_iv")
    ), 
    tabPanel(
      "Binomial calibration accuracy test", 
      dataTableOutput("tbl_bin_colibration")
    ),
    tabPanel(
      "Migration analysis",
      dataTableOutput("migration_analysis")
    )
  )
)

# Define server logic ----
server <- function(input, output) {
  output$tbl_df_numerics <- renderDataTable({
    #?????????????? ?????? ???????????? ?????????????? ???????????????? ???????????????????? 
      # min, max ???????????????? ?? ?????????????? ?????????????????????? ??????????????(?????????????????????? ????????????????)
      # ???? ?????????????????? ???????????? ????????
    #abt_meta[abt_meta$Type == 'interval' & abt_meta$Role == 'Input', ]$Variable - ?????? ?????????????? ???????????????? ???????????????????? ?????? ????????????
    numerics <- as.data.frame(abt_meta[abt_meta$Type == 'interval' & abt_meta$Role == 'Input', ]$Variable)
    colnames(numerics) <- "Factor"
    numerics$min <- 0
    numerics$max <- 0
    numerics$special_symbols <- 0
    for (tmp in numerics$Factor) {
      numerics[numerics$Factor == tmp, ]$min <-
        min(df[df$period_label == input$select_period_numeric, ][[tmp]])
      numerics[numerics$Factor == tmp, ]$max <-
        max(df[df$period_label == input$select_period_numeric, ][[tmp]])
      numerics[numerics$Factor == tmp, ]$special_symbols <-
        sum(is.nan(df[df$period_label == input$select_period_numeric, ][[tmp]]))
    }
    colnames(numerics) <- c("factor", "actual minimum value", "actual maximum value", "special symbols")
    return(datatable(numerics, rownames = FALSE, options = list(searching = FALSE, paging = FALSE))
           %>% formatPercentage("special symbols", DECIMAL_PLACES)) %>%
      formatRound(c("actual minimum value", "actual maximum value"), DECIMAL_PLACES)
  })
  output$tbl_df_factors <- renderDataTable({
    #?????????????? ?????? ???????????? ?????????????? ?????????????????? ???????????????????? ???????????????????? ?????????????????????? ??????????????(?????????????????????? ????????????????)
      # ???? ?????????????????? ???????????? ???????????????????? (input$select_period_character) TEST/TRAIN
    #abt_meta[abt_meta$Type == 'character' & abt_meta$Role == 'Input', ]$Variable - ?????? ?????????????? ?????????????????? ?? ?????????????????? ???????????????????? ?????? ????????????
    df_character_summary <<- as.data.frame(abt_meta[abt_meta$Type == 'character' & abt_meta$Role == 'Input', ]$Variable)
    colnames(df_character_summary) <<- "Factor"
    df_character_summary$special_symbols <<- 0
      for (tmp in df_character_summary$Factor) {
        df_character_summary[df_character_summary$Factor == tmp, ]$special_symbols <- 
          sum(df[df$period_label == input$select_period_character, ][tmp] == "UNKNOWN") / 
          nrow(df[df$period_label == input$select_period_character, ][tmp])
      }
    colnames(df_character_summary) <- c("factor", "special symbols")
    return(datatable(df_character_summary, rownames = FALSE, options = list(searching = FALSE))
           %>% formatPercentage("special symbols", DECIMAL_PLACES))
    })
  output$tbl_df_dr <- renderDataTable({
    # ?????????????? ?????? ???????????? ???????????? ???????? ?????????? ????????????????????, ?????????? ?????????????? ?? ?????????????? ???????????????? ?????????? ???????????? ???? ?????? ???????????? ????????
    ans <- df %>%
      grouped_df("period") %>% 
      summarise (
        num_of_observation = n(),
        num_of_defaults = sum(default_flg),
        default_rate = num_of_defaults / num_of_observation
      )
    ans$period <- sapply(ans$period, function(z) {
      if (z == 1)
        return ("TRAIN")
      return(report_dates[z-1])
    })
    return(datatable(ans, rownames = FALSE, options = list(searching = FALSE), 
                     caption = "General information") %>% formatPercentage("default_rate", DECIMAL_PLACES))
  })
  output$plt <- renderPlot({
    #???????????????? ???? ?????????? ?????????????? ?????????????????????????? ???????????????? ???????????????????? input$select_factor ???? ???????????????? TEST ?? TRAIN
    df_test <- df[df$period_label == "TEST", ]
    df_train <- df[df$period_label == "TRAIN", ]
    #?????? ???????????????? ???????????????????? ?????????????????????? ?????????? if true, ?????? ???????????????????? ?????????? else
    #?? ???????????? 2 ?????????????? ?? ?????????????????????????? 0.5 ???????????????????? ???????????????????? ???????????? ????????????
    if (abt_meta[abt_meta$Variable == input$select_factor, ]$Type == 'interval') 
      return (
        ggplot() +
          geom_histogram(data = df_test, aes(x = df_test[, input$select_factor], y = 100 * ..count../sum(..count..), fill = "TEST"), bins = 100, alpha = 0.5) +
          geom_histogram(data = df_train, aes(x = df_train[, input$select_factor], y = 100 * ..count../sum(..count..), fill = "TRAIN" ), bins = 100, alpha = 0.5) +
          labs (y = "percentage", x = input$select_factor)
      )
    else
      return (
        ggplot() +
          geom_bar(data = df_test, aes(x = df_test[, input$select_factor], y = 100 * ..count../sum(..count..), fill = "TEST"), bins = 100, alpha = 0.5) +
          geom_bar(data = df_train, aes(x = df_train[, input$select_factor], y = 100 * ..count../sum(..count..), fill = "TRAIN" ), bins = 100, alpha = 0.5) +
          labs (y = "percentage", x = input$select_factor)
      )
  })
  output$plot_con_dr <- renderPlot({
    #?? ???????????????? ?????????????????? ?????????????????? (input$dates[1],input$dates[2]) ?????? ?????????????????? ???????????????????? (input$select_factor_gr_d)
      # ???????????? ?????????????? ???????????????????????? ???????????????????? ???????????????????????? ???? ???????? ???????????????? ???????????????????? (?????????????????????????? ???????????????????? ???????????????????? ???? ??????????????????)
      # ?? ?????????????? ???????????? ?????????????? ?????? ?????????????? ???????????????? ????????????????????
      # ?????? ?????????????? ???? ???????????????? TEST ?? TRAIN 
    list_of_df <- list()
    i <- 1
    #?? df_for_plot ???????????????????? ???? ?????????????? ???????????????? ????????????????????, ?????? ?????????????? ?????????????????? concetration, defaut rate
    for (period_tmp in unique(df$period_label)) {
      tmp_df <- df[df$period_label == period_tmp & df$REPORT_DT >= input$dates[1] & df$REPORT_DT <= input$dates[2], ] %>%
        grouped_df(input$select_factor_gr_dr) %>% 
        summarise(
          concentration = as.numeric(n() / count(df[df$period_label == period_tmp, ])),
          dr = mean(default_flg)
        )
      if (length(tmp_df$dr) > 0)
        tmp_df$period_label <- period_tmp
      list_of_df[[i]] <- as.data.frame(tmp_df)
      i <- i + 1
    }
    df_for_plot <- do.call("rbind", list_of_df)
    #???????? ?????????????????? ?????????????? 0 ???????????????????? ?????????????? ????????????????????????????
    if (nrow(df_for_plot) == 0){
      showNotification("0 records selected", type = "error")#?????????????? ???????????? ???????????? ?? ???????????????? 0 records selected
      return (0)
    }
    #?????????? ???????????????????? ?? ?????????? ?????? ?????????????? ???????????????????????? ????????????????
    coeff <- (max(df_for_plot$dr) - min(df_for_plot$dr)) / max(df_for_plot$concentration)
    shift <- min(df_for_plot$dr)
    ggplot(df_for_plot) +
      geom_bar(
        aes(
          x = as.factor(round(df_for_plot[[input$select_factor_gr_dr]], DECIMAL_PLACES)),
          y = concentration,
          fill = factor(df_for_plot$period_label)
        ),
        stat = "identity",
        position = position_dodge(0.7),
        width = 0.3
      ) +
      geom_line(
        aes(      
          x = as.factor(round(df_for_plot[[input$select_factor_gr_dr]], DECIMAL_PLACES)),
          # ???????????????????????? ?????? ??????????????, ?????? ???? ?????????????? ???????????? ?????????? max min ?????? ????????????????
          y = (df_for_plot$dr - shift) / coeff,
          group = factor(df_for_plot$period_label),
          linetype = factor(df_for_plot$period_label)
        ),
        size = 1
      ) +
      geom_point(
        aes(
          x = as.factor(round(df_for_plot[[input$select_factor_gr_dr]], DECIMAL_PLACES)),
          # ???????????????????????? ?????? ??????????, ?????? ???? ?????????????? ???????????? ?????????? max min ?????? ????????????????
          y = (df_for_plot$dr - shift) / coeff,
          group = factor(df_for_plot$period_label),
          shape = factor(df_for_plot$period_label)
        )
      ) +
      labs(x = input$select_factor_gr_dr, fill = "concentration of observations", shape = "default rate", linetype = "Default rate") +
      scale_y_continuous(labels = percent_format(), 
                         sec.axis = sec_axis(~. * coeff + shift, , name = "Default rate", labels = percent_format())
      )
  })
  #???????????? ?? ???????????? / gini < 0 gini > 0
  ## ?????????? ?????????????????????? ???????? ???????????? Somers'D (https://support.sas.com/documentation/cdl/en/statug/63033/HTML/default/viewer.htm#statug_logistic_sect035.htm)
  output$Gini_report_plt <- renderPlot({
    tmp_df_gini <- data.frame(matrix(ncol = 2, nrow = 0))
    colnames(tmp_df_gini) <- c("period_tmp", "Dxy")
    for (per in as.list(unique(df$REPORT_DT))) {
      adding_df <- data.frame(
        period_tmp = per,
        Dxy = somers2(
          df[df$REPORT_DT == per, ][[input$select_factor_gini]], 
          df[df$REPORT_DT == per, ][["default_flg"]]
        )[["Dxy"]], 
        stringsAsFactors = FALSE
      )
      tmp_df_gini <- rbind(tmp_df_gini, adding_df)
    }
    ggplot() +
      geom_line(
        aes(
          x = tmp_df_gini$period_tmp,
          y = tmp_df_gini$Dxy
        )
      ) +
      xlab("period") +
      ylab("Dxy")
  })
  output$Gini_per_factor_tbl <- DT::renderDataTable({
    if (as.Date(input$select_report_dt) == min(unique(df$REPORT_DT))) {
      tmp_df_gini <- data.frame(matrix(ncol = 3, nrow = 0))
      colnames(tmp_df_gini) <- c("factor", "Dxy", "trafic_light_absolute_value")
      for (fac in group_factors) {
        Dxy_curr <- somers2(
          df[df$REPORT_DT == as.Date(input$select_report_dt), ][[fac]], 
          df[df$REPORT_DT == as.Date(input$select_report_dt), ][["default_flg"]]
        )[["Dxy"]]
        
        if (Dxy_curr < TRAFFIC_LIGHTS["GINI_FACTORS_RED"])
          color <- "red"
        if (Dxy_curr >= TRAFFIC_LIGHTS["GINI_FACTORS_RED"] & Dxy_curr < TRAFFIC_LIGHTS["GINI_FACTORS_GREEN"])
          color <- "yellow"
        if (Dxy_curr >= TRAFFIC_LIGHTS["GINI_FACTORS_GREEN"])
          color <- "green"
        
        adding_df <- data.frame(
          factor = fac, 
          Dxy = Dxy_curr, 
          trafic_light_absolute_value = color,
          stringsAsFactors = FALSE
        )
        tmp_df_gini <- rbind(tmp_df_gini, adding_df)
      }
      datatable(tmp_df_gini, rownames = FALSE, options = list(searching = FALSE)) %>%
        formatStyle(
          columns = "trafic_light_absolute_value", 
          background = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
        )
    }
    else {
      tmp_df_gini <- data.frame(matrix(ncol = 5, nrow = 0))
      colnames(tmp_df_gini) <- c("factor", "Dxy", "trafic_light_absolute_value", "difference", "trafic_light_relative_value")
      for (fac in group_factors) {
        current_period <- as.Date(input$select_report_dt)
        
        # TO-DO check if prev month existing
        
        previous_period <- sort(unique(df$REPORT_DT))[match(as.Date(input$select_report_dt), sort(unique(df$REPORT_DT))) - 1]
        Dxy_curr <- somers2(
          df[df$REPORT_DT == current_period, ][[fac]], 
          df[df$REPORT_DT == current_period, ][["default_flg"]]
        )[["Dxy"]]
        Dxy_prev <- somers2(
          df[df$REPORT_DT == previous_period, ][[fac]], 
          df[df$REPORT_DT == previous_period, ][["default_flg"]]
        )[["Dxy"]]
        if (Dxy_curr < TRAFFIC_LIGHTS["GINI_FACTORS_RED"])
          color_1 <- "red"
        if (Dxy_curr >= TRAFFIC_LIGHTS["GINI_FACTORS_RED"] & Dxy_curr < TRAFFIC_LIGHTS["GINI_FACTORS_GREEN"])
          color_1 <- "yellow"
        if (Dxy_curr >= TRAFFIC_LIGHTS["GINI_FACTORS_GREEN"])
          color_1 <- "green"
        
        if ((Dxy_curr - Dxy_prev) / Dxy_prev >= TRAFFIC_LIGHTS["GINI_RELATIVE_FACTORS_RED"])
          color_2 <- "red"
        if ((Dxy_curr - Dxy_prev) / Dxy_prev >= TRAFFIC_LIGHTS["GINI_RELATIVE_FACTORS_GREEN"] & (Dxy_curr - Dxy_prev) / Dxy_prev < TRAFFIC_LIGHTS["GINI_RELATIVE_FACTORS_RED"])
          color_2 <- "yellow"
        if ((Dxy_curr - Dxy_prev) / Dxy_prev < TRAFFIC_LIGHTS["GINI_RELATIVE_FACTORS_GREEN"])
          color_2 <- "green"
        
        adding_df <- data.frame(
          factor = fac,
          Dxy = Dxy_curr,
          trafic_light_absolute_value = color_1,
          difference = (Dxy_curr - Dxy_prev) / Dxy_prev,
          trafic_light_relative_value = color_2,
          stringsAsFactors = FALSE
        )
        tmp_df_gini <- rbind(tmp_df_gini, adding_df)
      }
      colnames(tmp_df_gini) <- c("factor", "gini", "absolute value of traffic light")
      datatable(tmp_df_gini, rownames = FALSE, options = list(searching = FALSE)) %>%
        formatStyle(
          columns = "absolute value of traffic light", 
          background = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
        ) %>%
        formatPercentage(c("gini"), DECIMAL_PLACES)
    }
  })
  output$ks_plot <- renderPlot({
    #???????????????? ???????????????? ??????????????????????-????????????????
    ggplot() + 
      stat_function(aes(x=seq(from=min(df$PD), to=max(df$PD), length.out=50)), fun = ecdf(df[df$default_flg == 1 & df$period_label == input$select_period_ks,]$PD)) +
      stat_function(aes(x=seq(from=min(df$PD), to=max(df$PD), length.out=50)), fun = ecdf(df[df$default_flg == 0 & df$period_label == input$select_period_ks,]$PD))
  })
  output$tbl_iv <- renderDataTable({
    # tbl_iv - ???????????? ?????????????? Information Value ?????????? ?????????????? WOETable,?????? ?????????????????? ???????????? ???????? input$select_report_dt_iv
    # df <- df[df$period_label == "TRAIN", ]
    factor <- vector()
    iv <- vector()
    tmp_df <- df[df$REPORT_DT == input$select_report_dt_iv, ]
    
    for (tmp in group_factors) {
      tbl_woe <- WOETable(factor(tmp_df[tmp][, 1]), tmp_df$default_flg)
      factor <- c(factor, tmp)
      iv <- c(iv, sum(tbl_woe$IV))
    }
    ans <- data.frame(factor, iv)
    ans["traffic_light"] <- sapply(ans$iv, function(iv) {
      if (iv <= TRAFFIC_LIGHTS["iv_red"])
        return ("red")
      if (iv <= TRAFFIC_LIGHTS["iv_yellow"])
        return ("yellow")
      return ("green")
    })
    ans <- datatable(ans, rownames = FALSE, options = list(searching = FALSE),
                     caption = paste0("Information value test. yellow zone: ",TRAFFIC_LIGHTS["iv_red"], " - ", 
                                      TRAFFIC_LIGHTS["iv_yellow"]," red zone: <= ", TRAFFIC_LIGHTS["iv_red"])) %>%
      formatStyle(
        'traffic_light',
        backgroundColor = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
      ) %>% formatRound(colnames(ans), DECIMAL_PLACES)
    return(ans)
  })
  bayes_adjustment <- function(default_rate, defaultRateTot) {
    #bayes_adjustment - ?????????????????????????? ????????????
      #default_rate - ???????? ????????????????
      #default_rateTot - ???????? ???????????????? ???? ???????? ???????? ????????????
    return (default_rate * (CENTRAL_TREND / defaultRateTot) / 
              ((1 - default_rate) * (1 - CENTRAL_TREND) / (1 - defaultRateTot) + default_rate * CENTRAL_TREND / defaultRateTot))
  }
  do_bin_collibration <- function(meanPD_total, total_obs, confedence_level_yellow, confedence_level_red) {
    #do_bin_collibration - ???????????????????????? ???????? ???? ???????????????? ???????????? ????????????????????
      #meanPD_total - ?????????????? ???????????????? PD ???? ?????????????? ?????? ??????????????????
      #total_obs - ?????????? ?????????? ???????????????????? 
      #confedence_level_yellow - ???????????? ?????????????????????????? ????????????????
      #confedence_level_red - ?????????????? ?????????????????????????? ????????????????
    PD_lower_yellow <- qnorm(1 - confedence_level_yellow) * sqrt(meanPD_total * (1 - meanPD_total) / total_obs) + meanPD_total
    PD_upper_yellow <- qnorm(confedence_level_yellow) * sqrt(meanPD_total * (1 - meanPD_total) / total_obs) + meanPD_total;
    PD_lower_red <- qnorm(1 - confedence_level_red) * sqrt(meanPD_total * (1 - meanPD_total) / total_obs) + meanPD_total;
    PD_upper_red <- qnorm(confedence_level_red) * sqrt(meanPD_total * (1 - meanPD_total) / total_obs) + meanPD_total;
    trafficc_light <- "green"
    if ( (PD_lower_red > CENTRAL_TREND) || (PD_upper_red < CENTRAL_TREND) ) 
      trafficc_light <- "red"
    if (PD_lower_yellow > CENTRAL_TREND | PD_upper_yellow < CENTRAL_TREND) 
      trafficc_light <- "yellow"
    ans <- data.frame(CENTRAL_TREND, meanPD_total, PD_lower_yellow, PD_upper_yellow, PD_lower_red, PD_upper_red, trafficc_light)
  }
  output$tbl_Xi2 <- renderDataTable({
    #tbl_Xi2 ???????????????????? ?????????????? ?????????? Xi2
    #df_val - ?????????????? ???? ???????????? ??????????????????
    df_val <- df[df$period > 1, ]
    #defaultRateTot - ???????? ???????????????? ?? ????????????????????
    defaultRateTot <- (nrow(df_val[df_val$default_flg == 1, ])) / nrow(df_val)
    #???????????????????? ????????????????????, ?????????????? PD, ?? ???????? ???????????????? ?????? ???????????? ???????????? ???????????? ?????????? ???????????? df_val
    df_val <- df_val %>% 
      grouped_df("rating") %>%
    summarise (
        num_obs = n(),
        mean_PD = mean(PD),
        default_rate = sum(default_flg) / num_obs
      )
    Xi2 <- c()
    #?????????????????????????? ???????????? ???????? ?????????? ?? ???????????????????? Xi2 ((num_obs * mean_PD - num_obs * default_rate) ** 2) / (num_obs * mean_PD * (1 - mean_PD))
    for(i in 1:length(RATING_VECTOR)) {
      if (input$bayes_adjustment_xi2)
        df_val$default_rate[i] <- bayes_adjustment(df_val$default_rate[i], defaultRateTot)
      Xi2 <- c(Xi2, ((df_val$num_obs[i] * df_val$mean_PD[i] - df_val$num_obs[i] * df_val$default_rate[i]) ** 2) / (df_val$num_obs[i] * df_val$mean_PD[i] * (1 - df_val$mean_PD[i])))
    }
    df_val <- cbind(df_val, Xi2)
    #?????????????????? ???????????????????? ??????????????-????????????????
    statistic_HL <- sum(df_val$Xi2)
    p_value <- 1 - pchisq(statistic_HL, length(RATING_VECTOR))
    if (p_value < TRAFFIC_LIGHTS["p_value_red"])
      trafficc_light <- "red"
    if (p_value >= TRAFFIC_LIGHTS["p_value_red"] && p_value < TRAFFIC_LIGHTS["p_value_yellow"])
      trafficc_light <- "yellow"
    if (p_value > TRAFFIC_LIGHTS["p_value_yellow"])
      trafficc_light <- "green"
    
    #???????????? ???????????????? ??????????????-???????????????? ?? ??????????????
    tbl_hl <- data.frame(statistic_HL, p_value, trafficc_light)
    colnames(tbl_hl) <- c("Hosmer-Lemeshev statistics", "pValue", "traffic light")
    tbl_hl <- datatable(tbl_hl, rownames = FALSE, options = list(searching = FALSE)) %>%
      formatStyle(
        'traffic light', 
        backgroundColor = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
      ) %>%
      formatPercentage("pValue", DECIMAL_PLACES) %>%
      formatRound(colnames(tbl_hl), DECIMAL_PLACES)
    colnames(df_val) <- c("rating", "frequency of observations", "estimated PD", "default frequency", "statistics chi-square for rating rank scales")
    output$tbl_HL_statistic <- renderDataTable(tbl_hl)
    
    #???????????? ???????????????? ????-?????????????? ?? ??????????????
    df_val <- datatable(
      df_val, rownames = FALSE, options = list(
        searching = FALSE,
        # pageLength = 25, 
        scrollX = TRUE, 
        paging = FALSE
        # lengthMenu = list(c(5, 15, -1), c('5', '15', 'All'))
      ),
      caption = paste0("PD estimation accuracy test (Hosmer-Lemeshev CHi-squared test). yellow zone: ",
                       TRAFFIC_LIGHTS["p_value_red"]*100, "%- ", TRAFFIC_LIGHTS["p_value_yellow"]*100, "% ", "red zone: < ",
                       TRAFFIC_LIGHTS["p_value_red"]*100,"%")
    ) %>% 
      formatPercentage(c("estimated PD", "default frequency"), DECIMAL_PLACES)%>%
      formatRound(colnames(df_val)[colnames(df_val) != "frequency of observations"], DECIMAL_PLACES)
    return (df_val)
  })
  output$tbl_bin_colibration <- renderDataTable({
    #tbl_bin_colibration - ???????????????????? ?????????????? - ???????? ???? ???????????????? ???????????? ???????????????????? (????????????????????????)
    #df_val - ?????????????? ???? ???????????? ??????????????????
    df_val <- df[df$period > 1, ]
    #total_obs - ?????????? ????????????????????  ???? ??????????????????
    total_obs <- nrow(df)
    #defaultRateTot - ???????? ???????????????? ???? ???????????? ??????????????????
    defaultRateTot <- (nrow(df[df$default_flg == 1, ]) / total_obs)
    #do_bin_collibration - ???????????????????????? ???????? ???? ???????????????? ???????????? ????????????????????
    ans <- do_bin_collibration(mean(df$PD), total_obs, TRAFFIC_LIGHTS["binomial_calibration_accuracy_test_confedence_level_yellow"], TRAFFIC_LIGHTS["binomial_calibration_accuracy_test_confedence_level_red"])
    # ???????????? ???????????????? ?? ??????????????
    ans <- datatable(ans, rownames = FALSE, options = list(searching = FALSE), 
                     caption = "Calibration level accuracy test (binomial)") %>%
      formatStyle(
        'trafficc_light', 
        #target = 'row', 
        backgroundColor = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
      ) %>%
      formatPercentage(colnames(ans), DECIMAL_PLACES)%>%
      formatRound(colnames(ans), DECIMAL_PLACES)
    return (ans)
  })
  output$tbl_curve <- renderDataTable({ 
    #tbl_curve - ?????????????? ?????????????? ?????????? ???? ???????????????? ?????????????????????????? ????????????  
    #df_val - ?????????????? ???? ???????????? ??????????????????
    df_val <- df[df$period > 1, ]
    #defaultRateTot - ???????? ???????????????? ???? ???????????? ??????????????????
    defaultRateTot <- (nrow(df_val[df_val$default_flg == 1, ])) / nrow(df_val)
    #???????????????????? ????????????????????, ?????????????? PD, ?? ???????? ???????????????? ?????? ???????????? ???????????? ???????????? ?????????? ???????????? df_val
    df_val <- df_val %>% 
      grouped_df("rating") %>%
    summarise (
        num_obs = n(),
        mean_PD = mean(PD),
        default_rate = sum(default_flg) / num_obs
      )
    #?????????????????????????? ???????????? ???????? ?????????? ???????? ?? ???????? ????????????????????
    if (input$bayes_adjustment_xi2)
      for(i in 1:length(RATING_VECTOR))
        df_val$default_rate[i] <- bayes_adjustment(df_val$default_rate[i], defaultRateTot)
    #?????? ???????????? ???????????? ???????????? ?????????? ???????????? ???????????????????????? ???????? ???? ???????????????? ???????????? ????????????????????
    for (i in 1 : length(RATING_VECTOR)) {
      if (i == 1)
        df_val_bin <- do_bin_collibration(df_val$mean_PD[i], df_val$num_obs[i], TRAFFIC_LIGHTS["calibration_curve_accuracy_test_confedence_level_yellow"], TRAFFIC_LIGHTS["calibration_curve_accuracy_test_confedence_level_red"])
      else
        df_val_bin <- rbind(df_val_bin, do_bin_collibration(df_val$mean_PD[i], df_val$num_obs[i], TRAFFIC_LIGHTS["calibration_curve_accuracy_test_confedence_level_yellow"], TRAFFIC_LIGHTS["calibration_curve_accuracy_test_confedence_level_red"]))
    }
    #?????????????????? ?????????????????? ?? ???????????????? ?? ?????????????????? ?? ???????????????????????? ??????????,???????????????????? ???????????????? ??????????????
    df_val <- cbind(df_val, df_val_bin)
    df_val$CENTRAL_TREND <- NULL
    df_val$meanPD_total <- NULL
    
    df_val$PD_lower_yellow <- pmax(c(0), df_val$PD_lower_yellow)
    df_val$PD_upper_yellow <- pmin(c(1), df_val$PD_upper_yellow)
    df_val$PD_lower_red <- pmax(c(0), df_val$PD_lower_red)
    df_val$PD_upper_red <- pmin(c(1), df_val$PD_upper_red)
    #?????????????????? ??????????????????
    interpretation <- vector()
    for (i in 1 : nrow(df_val)) {
      if (df_val$trafficc_light[i] == 'green')
        interpretation[i] <- 'conformity' #???????????????????????? conformity
      else
      {
        if (df_val$mean_PD[i] > df_val$default_rate[i])
          interpretation[i] <- 'overestimation' #???????????????????? overestimation
        else interpretation[i] <- 'underestimation'; #???????????????????? underestimation
      }
    }
    df_val <- cbind(df_val, interpretation)
    PD_lower <- vector()
    PD_upper <- vector()
    for (i in 1 : nrow(df_val) ) {
      if (df_val$trafficc_light[i] == "green") {
        PD_lower[i] <- df_val$PD_lower_yellow[i]
        PD_upper[i] <- df_val$PD_upper_yellow[i]
      }
      else {
        PD_lower[i] <- df_val$PD_lower_red[i]
        PD_upper[i] <- df_val$PD_upper_red[i]
      }
    }
    #???????? ???????????????? ?????? ???????????? ?????? ?????????????? "???????????????????? ???????????????????? ?????????????????????????? ??????????"
    coeff <- max( c(df_val$default_rate, PD_upper) ) / ( (max(df_val$num_obs)) / nrow(df) )
    df_for_plot <- df_val
    #???????????? ???????????? ?????????????????? ?? ???????????????????????????? ????????????
    for(i in 1:length(RATING_VECTOR))
        df_for_plot$default_rate[i] <- bayes_adjustment(df_for_plot$default_rate[i], defaultRateTot)
    output$plot_curve_test <- renderPlot ({
      ggplot(df_for_plot)  + 
        #geom_bar - ???????? ???????????????????? ???? ??????????????
        geom_bar(
          aes(
            x = rating, 
            y = df_for_plot$num_obs / nrow(df),
            fill = "1"
          ),
          stat = "identity"
        )  + 
        scale_fill_manual (values = c("1" = "black")) + 
        geom_point(
          aes(
            x = rating, 
            y = df_for_plot$default_rate / coeff,
            shape = ""
          ),
          color = "red"
        )  + 
        # ?????????????? PD
        geom_errorbar(
          aes(
            x = rating, 
            ymin= PD_lower / coeff, 
            ymax= PD_upper / coeff
          ),
          color = "red"
        )  + 
        # ?????????????? ?????????????? ?????????? ?????????????????? PD
        geom_linerange (
          aes(
            x = rating
          ), 
          ymin = PD_lower / coeff, 
          ymax = PD_upper / coeff, 
          color = "red"
        )  + 
        # ?????????????? ?????????????? ?????????? PD_upper ?? ???????????? ????????????
        geom_linerange(
          aes(
            x = rating
          ), 
          ymin = df_for_plot$default_rate / coeff, 
          ymax = PD_upper / coeff, 
          color = "red"
        ) +
        #?????????????????? ????????, ??????????????
        scale_y_continuous(labels = percent_format(), name = "Rate of observations",
                           sec.axis = sec_axis(~.*coeff, name = "Default rate", labels = percent_format())) +
        labs(x =  "Rating", title = "Graphical results of the binomial test using a Bayesian adjustment", shape = "Default rate", fill = "Rate of observations") +
        theme(legend.position="bottom",
              legend.background = element_rect(fill = "lightblue",
                                               size = 0.5, linetype ="solid", 
                                               colour ="darkblue"))
    })
    # ???????????? ???????????????? ?????????? ???? ???????????????? ?? ??????????????
    colnames(df_val) <- c("rating", "number of observations", "PD - test result", "default frequency", 
                        "PD_lower_yellow", "PD_upper_yellow", "PD_lower_red", "PD_upper_red", "traffic light", "interpretation")
    df_val <- datatable(df_val, rownames = FALSE, options = list(paging = FALSE, searching = FALSE), caption = "Calibration curve accuracy test") %>%
      formatStyle(
        colnames(df_val), 
        backgroundColor = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
      ) %>%
      formatPercentage(c("PD - test result", "default frequency",
                         "PD_lower_yellow", "PD_upper_yellow", "PD_lower_red", "PD_upper_red"), DECIMAL_PLACES) %>%
      formatRound(colnames(df_val)[colnames(df_val) != "num_obs"], DECIMAL_PLACES)
    return (df_val)
  })
  output$plot_score_distribution <- renderPlot({
    #plot_score_distribution - ?????????????? ???????????? PSI
    #df_test - ?????????????? ?????? ????????????????????, df_train ?????????????? ?????? ??????????????????
    df_test <- df[df$period != 1, c("PD", "rating")]
    df_train <- df[df$period == 1, c("PD", "rating")]
    #?????????????? ???????? ???????????????????? ???????????????????????? ???? ???????????? ???????????? ????????????-??????????
    count_train <- nrow(df_train)
    count_test <- nrow(df_test)
    num_of_groups <- length(RATING_VECTOR)
    ratio_test <- aggregate(df_test$rating, by = list(df_test$rating), length)
    ratio_train <- aggregate(df_train$rating, by = list(df_train$rating), length)
    ratio_test <- as.data.frame(ratio_test[, 2] / count_test)
    ratio_train <- as.data.frame(ratio_train[, 2] / count_train)
    
    ans <- cbind(ratio_test, ratio_train)
    ans <- cbind(names(RATING_VECTOR), ans)
    colnames(ans) <- c("id_group","ratio_test", "ratio_train")
    #melt - ?????????????????????? 3 ?????????????? ?? 3, ???????????? id_group, ???????????? ????????????(TEST, TRAIN), ???????????? ????????????????
    ans <- melt(ans, id = "id_group")
    levels(ans$variable) <- c("TEST", "TRAIN")
    
    return (
      #???????????? ?????????????????????????? ???????????????????? ???????? ???? ????????????-??????????
      ggplot(ans, aes(x = id_group, y = value, group = variable)) + 
        geom_bar(
          aes(
            fill = variable
            # width = sapply(variable, width_column)
          ),
          stat = "identity",
          position = "dodge"# ????????????????
        ) + 
        scale_fill_manual(values = c("TEST" = "blue", "TRAIN" = "red")) +
        geom_line(
          aes(
            color = variable
            # sapply(variable, function(x) ({
            # if (x == "ratio_test")
            #   return ("black")
            # else
            #   return ("red")
            # })
          ),
          stat = "identity",
          size = 1
        ) +#scoring score distribution on master scale for test and train samples
        scale_colour_manual(values = c("TEST" = "yellow", "TRAIN" = "black")) +
        scale_y_continuous("percentage of total defaults happened in each group", labels = percent_format()) +
        labs(fill = "Bar", color = "line", title = "distribution of scoring points on a master scale on samples for test and train")
    )
  })
  tbl_psi_function <- function(df, report_date, traffic_light_red, traffic_light_yellow) ({
    # tbl_psi_function - ???????????? ?????????????? psi
    # df - ??????????????????, report_date - ???????????? ????????, traffic_light_red *yellow... - ??????????????????
    #???????????? ??????????????????, ???????????????????? ???? ???????????? ????????????
    df_test_global <- df[df$period != 1 & df$REPORT_DT == report_date, ]
    df_validation_global <- df[df$period == 1 & df$REPORT_DT == report_date, ]
    count_test <- nrow(df_test_global)
    count_validation <- nrow(df_validation_global)
    i <- 0
    for (tmp in group_factors) {
      # ?????????????? ?????????????????????????? ????????????????????
      df_test <- df_test_global[, c(tmp , "PD")]
      df_validation <- df_validation_global[, c(tmp, "PD")]
      x <- aggregate(df_test[, tmp], list(df_test[, tmp]), function(z)({length(z) / count_test}))
      y <- aggregate(df_validation[, tmp], list(df_validation[, tmp]), function(z)({length(z) / count_validation}))
      colnames(x) <- c("factor", "test_ratio")
      colnames(y) <- c("factor", "validation_ratio")
      #?????????????? psi
      x <- x[order(x$factor), ]
      y <- y[order(y$factor), ]
      x <- merge.data.frame(x, y, by = "factor")
      x["inter_PSI"] <- ((x$validation_ratio - x$test_ratio) * log(x$validation_ratio / x$test_ratio))
      if (i == 0)
        ans <- as.data.frame(t(c(tmp, sum(x["inter_PSI"]))))
      else
        ans <- rbind(ans, t(c(tmp, sum(x["inter_PSI"]))))
      i <- i + 1
    }
    #?????????????????? ??????????????????
    colnames(ans) <- c("factor", paste("PSI", report_date))
    ans[, paste("PSI", report_date)] <- as.numeric(as.character(ans[, paste("PSI", report_date)]))
    traffic_light <- sapply(ans$PSI, function(x) {
      if (x > traffic_light_red)
        return ("red")
      if (x > traffic_light_yellow)
        return ("yellow")
      return ("green")
    })
    ans <- cbind(ans, traffic_light)
    colnames(ans)[3] <- paste("traffic_light", report_date)
    return (ans)
  })
  output$tbl_psi <- renderDataTable({
    # tbl_psi - ???????????????? ?????????????? tbl_psi_function - ???????????????? ?????????????? ???????????? ?????????????? psi, ?????????? ???????????? ?? ?????????????? ????????????????
    # df <- df[df$period_label == "TRAIN", ]
    ans <- tbl_psi_function(df, input$select_report_dt_PSI, TRAFFIC_LIGHTS["psi_red"], TRAFFIC_LIGHTS["psi_yellow"])
    ans <- ans[, c("factor", paste(c("PSI", "traffic_light"), input$select_report_dt_PSI))]
    ans <- datatable(ans, rownames = FALSE, caption = paste0("PSI test results. yellow zone: ", options = list(searching = FALSE),
                                                             TRAFFIC_LIGHTS["psi_yellow"], " - ", TRAFFIC_LIGHTS["psi_red"], " red zone: > ", TRAFFIC_LIGHTS["psi_red"])) %>%
      formatStyle(
        colnames(ans), 
        #target = 'row', 
        backgroundColor = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
      ) %>% formatRound(colnames(ans), DECIMAL_PLACES)
    return (ans)
  })
  output$tbl_representativeness <- renderDataTable({
    # tbl_representativeness - ???????????? psi ???? ???????????? ???????????? ???????? :(
      # ???????????????? ?????? period = 0, ???? ?????????? ???? ????????????????????
      # ?? ?????????????????? ?????????????????? ??????
    portfolio_period <- min(df$REPORT_DT)
    ans <- tbl_psi_function(df, portfolio_period, TRAFFIC_LIGHTS["representativeness_red"], TRAFFIC_LIGHTS["representativeness_yellow"])
    colnames(ans) <- c("factor", "PSI Portfolio", "Traffic light Portfolio")
    ans <- datatable(ans, rownames = FALSE, options = list(searching = FALSE), 
                     caption = paste0("Representativeness. yellow zone: ", TRAFFIC_LIGHTS["representativeness_yellow"]," - ",
                                      TRAFFIC_LIGHTS["representativeness_red"], " red zone: > ", TRAFFIC_LIGHTS["representativeness_red"])) %>%
      formatStyle(
        colnames(ans),
        backgroundColor = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
      ) %>% formatRound(colnames(ans), DECIMAL_PLACES)
  })
  output$tbl_correlation_analysis_of_gr_factors <- renderDataTable({
    #tbl_correlation_analysis_of_gr_factors - ???????????? ?????????????? ???????????????????? 
      #?????? ???????????????? (input$Correlation_gr_variables) ?????????????????? ????????????????
    #df_gr_factors - df ?? ?????????????????? ?????????? ???????????????????? ??????????????????
    df_gr_factors <- df[, group_factors]
    # ans - ?????????????? ???????????????????? ?????????????????? ????????????????
    ans <- cor(df_gr_factors)
    rownames(ans) <- colnames(ans)
    # ?????????????????? ?? ans ???????????? ???? ???????????? ?? ??????????????, ?????????????? ?????????????? ???????????? ?? ???????????????????? (input$Correlation_gr_variables)
    ans <- ans[rownames(ans) %in% input$Correlation_gr_variables, colnames(ans) %in% input$Correlation_gr_variables]
    # ???????? ???????????? 0 ?????? 1 ????????????, ?????????????? ?????????????? ?????????????? ???????? ???? 2
      # c 0 ?????? 1 R ???? ????????????  ??????????????
    if (length(input$Correlation_gr_variables) < 2) {
      error <- as.data.frame("please select at least 2 variables")
      return (
        datatable(error,
                  rownames = FALSE) %>% 
          formatStyle(
            colnames(error),
            target = 'row', 
            backgroundColor = "red"
          )
      )
    }
    #?????????????? ?????????? - ???????????????? ?? ???????????????????????? ???????????? ????????????????
    ans <- datatable(ans, rownames = TRUE, caption = "??orrelation analysis of grouped factors of the model",
                     options = list(searching = FALSE)) %>%
      formatStyle(
        colnames(ans), 
        #target = 'row', 
        backgroundColor = styleInterval(c(-TRAFFIC_LIGHTS["correlation_gold"], -TRAFFIC_LIGHTS["correlation_red"], TRAFFIC_LIGHTS["correlation_red"], TRAFFIC_LIGHTS["correlation_gold"]), c('gold', 'red', 'white', 'red', 'gold'))
      ) %>% formatRound(colnames(ans), DECIMAL_PLACES)
    return (ans)
  })
  output$tbl_correlation_analysis_of_none_gr_factors <- renderDataTable({
    #tbl_correlation_analysis_of_none_gr_factors -???????????? ?????????????? ???????????????????? 
      #?????? ?????????????????? (input$Correlation_none_gr_variables)???? ?????????????????? ????????????????
    #df_factors - df ?? ?????????????????? ?????????? ???? ???????????????????? ??????????????????
    df_factors <- df[, none_gr_factors]
    # ans - ?????????????? ???????????????????? ???? ?????????????????? ????????????????
    ans <- cor(df_factors)
    rownames(ans) <- colnames(ans)
    # ?????????????????? ?? ans ???????????? ???? ???????????? ?? ??????????????, ?????????????? ?????????????? ???????????? ?? ???????????????????? (input$Correlation_none_gr_variables)
    ans <- ans[rownames(ans) %in% input$Correlation_none_gr_variables, colnames(ans) %in% input$Correlation_none_gr_variables]
    # ???????? ???????????? 0 ?????? 1 ????????????, ?????????????? ?????????????? ?????????????? ???????? ???? 2
      # c 0 ?????? 1 R ???? ????????????  ??????????????
    if (length(input$Correlation_none_gr_variables) < 2) {
      error <- as.data.frame("please select at least 2 variables")
      return (
        datatable(error,
                  rownames = FALSE) %>% 
          formatStyle(
            colnames(error),
            target = 'row', 
            backgroundColor = "red"
          )
      )
    }
    #?????????????? ?????????? - ???????????????? ?? ???????????????????????? ???????????? ????????????????
    ans <- datatable(ans, rownames = TRUE, caption = "??orrelation analysis of none grouped factors of the model",
                     options = list(searching = FALSE)) %>%
      formatStyle(
        colnames(ans), 
        #target = 'row', 
        backgroundColor = styleInterval(c(-TRAFFIC_LIGHTS["correlation_gold"], -TRAFFIC_LIGHTS["correlation_red"], TRAFFIC_LIGHTS["correlation_red"], TRAFFIC_LIGHTS["correlation_gold"]), c('gold', 'red', 'white', 'red', 'gold'))
      ) %>% formatRound(colnames(ans), DECIMAL_PLACES)
    return (ans)
  })
  
  output$tbl_inflation_factor_for_factors <- renderDataTable({# stop here ----
    # tbl_inflation_factor_for_factors - ???????????? ???????????????? VIF ?????? ???????????????? ???????????? ????????(input$select_report_dt_VIF)
    #factors_for_analysis - ???????? ?????????????????? ??????????????, ???????? ?????????????????? ?? ?????????????????????? ???? 
      #input$factors_VIF ?????????? ???? ?????? ????????????????????
    if (input$factors_VIF)
      factors_for_analysis <- group_factors
    else
      factors_for_analysis <- none_gr_factors
    # df_factors_for_report_date - ?????????????????????? ???????????????? ???????????? ?? ?????????????? ?????????????????? ?? ???????????? ???????????? ??????????
    df_factors <- df[ , c("default_flg", "REPORT_DT", factors_for_analysis)]
    df_factors_for_report_date <- df_factors[df_factors$REPORT_DT == input$select_report_dt_VIF, ]
    # str - ???????????? ?????????????? ???????????? ?? ???????? ????????????
    str <- paste("default_flg", paste(factors_for_analysis, collapse = " + "), sep = " ~ ")
    # ???????????? VIF 
    VIF_tbl <- as.data.frame(vif( lm(as.formula(str), data= df_factors_for_report_date) ))
    #?????????????????? ????????????????
    traffic_light <- sapply(VIF_tbl[, 1], function(x) {
      if (x > TRAFFIC_LIGHTS["vif_red"])
        return ("red")
      if (x > TRAFFIC_LIGHTS["vif_yellow"])
        return ("yellow")
      return ("green")
    })
    #???????????? ?? ?????????????? ???????????????? VIF_tbl
    VIF_tbl <- cbind (as.data.frame(rownames(VIF_tbl)), VIF_tbl)
    VIF_tbl <- cbind(VIF_tbl, traffic_light)
    colnames(VIF_tbl) <- c("factor", paste("VIF", input$select_report_dt_VIF), paste( "traffic_light", input$select_report_dt_VIF))
    VIF_tbl <- VIF_tbl[, c("factor", paste(c("VIF", "traffic_light"), input$select_report_dt_VIF))]
    VIF_tbl <- datatable(VIF_tbl, rownames = FALSE, options = list(searching = FALSE), 
                     caption = paste0("Model inflation factor calculated at model level. yellow zone: ", 
                                      TRAFFIC_LIGHTS["vif_yellow"], " - ", TRAFFIC_LIGHTS["vif_red"], " red zone: > ", TRAFFIC_LIGHTS["vif_red"]) )%>%
      formatStyle(
        colnames(VIF_tbl),
        #target = 'row', 
        backgroundColor = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
      )  %>% formatRound(colnames(VIF_tbl), DECIMAL_PLACES)
    return (VIF_tbl)
  })
  output$tbl_herfendal_index <- renderDataTable({
    #tbl_herfendal_index ???????????? ?????????????? ?? ?????????????????? ???????????????????? ???? ?????? ??????????????
    #?? ???????? ???????????????? ???????????? ???? train
    df_factors <- df[ , group_factors]
    ans <- as.data.frame(period_labels)
    herfendal_index <- vector()
    # ?????????????? ???????????? ???????????????????? ?? ???????????? herfendal_index
    for (report_date in report_dates) {
      count_num <- rep(0, length(RATING_VECTOR))
      names(count_num) <- names(RATING_VECTOR)
      for (rating_tmp in names(RATING_VECTOR))
        count_num[rating_tmp] <- nrow(df[df[, "REPORT_DT"] == report_date & df[, "rating"] == rating_tmp, ])
      count_num <- count_num / sum(count_num)
      herfendal_index <- c(herfendal_index, count_num %*% count_num )
    }
    # ?????????????????? ?????????????????? ?? ?????????????? ????????????????
    traffic_light <- sapply(herfendal_index, function(z) {
      if (z > TRAFFIC_LIGHTS["herfendal_index_red"]) 
        return ("red")
      if (z > TRAFFIC_LIGHTS["herfendal_index_yellow"])
        return ("yellow")
      return ("green")
    })
    ans <- cbind(ans, herfendal_index, traffic_light)
    colnames(ans) <- c("period", "herfendal index", "traffic light")
    ans <- datatable(ans, rownames = FALSE, options = list(searching = FALSE), 
                     caption = paste0("Herfendal index.", " yellow zone ", TRAFFIC_LIGHTS["herfendal_index_red"]*100,"% - ", TRAFFIC_LIGHTS["herfendal_index_yellow"]*100,
                                      "%, red zone: > ", TRAFFIC_LIGHTS["herfendal_index_red"]*100,"%")) %>%
      formatStyle(
        colnames(ans),
        #target = 'row', 
        backgroundColor = styleEqual(c("red", "yellow", "green"), c("red", "yellow", "green"))
      )  %>%
      formatPercentage("herfendal index", DECIMAL_PLACES) %>%
      formatRound(colnames("herfendal_index"), DECIMAL_PLACES)
    return (ans)
  })
  output$migration_analysis <- renderDataTable({
    #migration_analysis - ???????????? ?????????????????????????? ???????????? ?????????????? ?????? ???????????????????? ?? ?????????????? ?????? ??????????????????.
    df_train <- df[df$period == 1, ]
    df_test <- df[df$period > 1, ]
    scale_num <- length(RATING_VECTOR)
    
    #client_migrations ?????????????? ???????????????? ????????????????
    client_migrations <- merge(df_test, df_train, by = "id", all.x = TRUE)
    client_migrations <- client_migrations[, c("id", "rating.x", "rating.y")]
    colnames(client_migrations) <- c("id", "current segment", "old segment")
    
    #segment_migrations_group - ?????????????? ???????? ???????????????????? ?????? ?????????????? ?? ???????????????? ??????????????????
    segment_migrations_group <- client_migrations[!is.na(client_migrations["old segment"]), ]
    segment_migrations_group <- aggregate(client_migrations[,"id"], by = list(client_migrations[, "current segment"], client_migrations[, "old segment"]), length)
    colnames(segment_migrations_group) <- c("current segment", "old segment", "count")
    
    # full_pairs - ?????? ?????????????????? ???????? ??????????
    full_pairs <- merge(names(RATING_VECTOR), names(RATING_VECTOR))
    colnames(full_pairs) <- c("old segment", "current segment")
    
    #full_segment_migrations_group - ???????????? ?????????????? ???????????????? ?????????? ?? ???????????????????? 0 ????????????????????, ?????????????????????????????? ???? ??????????????????
    full_segment_migrations_group <- merge(full_pairs, segment_migrations_group, by = c("old segment", "current segment"), all.x = TRUE)
    full_segment_migrations_group$count[is.na(full_segment_migrations_group$count)] <- 0
    
    # migration_count_by_cur_period - ???????????????????? ????????????????, ???????????????????????? ???? ???????????? ???????????????? ?????????????? ????????????????
    migration_count_by_cur_period <- aggregate(full_segment_migrations_group[, "count"], by = list(full_segment_migrations_group[, "old segment"]), sum)
    names(migration_count_by_cur_period) <- c("old segment", "sum migration count")
    
    # full_segm_migr_grup_pct - ????????????????????????e ?????????? ???????????????? ?????? ?????????????? ???????????????? ?????????????? ????????????????
    full_segm_migr_grup_pct <- merge(full_segment_migrations_group, migration_count_by_cur_period, by = "old segment", all.x = TRUE)
    full_segm_migr_grup_pct["migration_pct"] <- full_segm_migr_grup_pct["count"] / full_segm_migr_grup_pct["sum migration count"]
    full_segm_migr_grup_pct <- full_segm_migr_grup_pct[, c("current segment", "old segment", "migration_pct")]#???????????????? ??????????????
    full_segm_migr_grup_pct <- full_segm_migr_grup_pct[order(full_segm_migr_grup_pct["current segment"], full_segm_migr_grup_pct["old segment"]), ]
    
    # ans - ???????????????????? ?????????????? ???????????????? ??????????????????
    ans <- reshape(full_segm_migr_grup_pct, direction = "wide", idvar = "old segment", timevar = "current segment")
    ans[, 2:ncol(ans)] <- t(ans[, 2:ncol(ans)])
    # ??????????????????????, ?????????????? ??????????????
    colnames(ans) <- c("current segment", paste("from", names(RATING_VECTOR)))
    # ans <- ans[ans[, "current segment"] %in% input$CURRENT_SEGMENT, colnames(ans) %in% c("current segment", paste("from", input$FROM_SEGMENT))]
    ans <- datatable(ans, rownames = FALSE, options = list(scrollX = TRUE,  paging = FALSE, searching = FALSE),
                     caption = "Migration analysis") %>%
      # "TURQUOISE" = 0, "AQUAMARINE" = 0.00001, "GREEN" = 0.02001, "YELLOW" = 0.05001, 
      # "ORANGE" = 0.10001, "SALMON" = 0.15001, "RED" = 0.20001, "FIREBRICK" = 0.25001)
      formatStyle(
        colnames(ans),
        #target = 'row', 
        backgroundColor = styleInterval(c(TRAFFIC_LIGHTS["AQUAMARINE"], TRAFFIC_LIGHTS["GREEN"]
                                          , TRAFFIC_LIGHTS["YELLOW"], TRAFFIC_LIGHTS["ORANGE"], TRAFFIC_LIGHTS["SALMON"],
                                          TRAFFIC_LIGHTS["RED"], TRAFFIC_LIGHTS["FIREBRICK"]), c('TURQUOISE', 'AQUAMARINE', 'GREEN', 'YELLOW', 'ORANGE', 'SALMON', 'RED', 'FIREBRICK'))
      )  %>%
      formatPercentage(colnames(ans), DECIMAL_PLACES) %>%
      formatRound(colnames(ans), DECIMAL_PLACES)
    return (ans)
  })
}

# Run the app ----
runApp(shinyApp(ui = ui, server = server), launch.browser = TRUE)#launch.browser = TRUE , display.mode = "showcase"